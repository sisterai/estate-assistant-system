apiVersion: v1
kind: ConfigMap
metadata:
  name: kubecost-config
  namespace: estatewise
data:
  kubecost.yaml: |
    prometheus:
      server:
        global:
          external_labels:
            cluster_id: estatewise-production

    kubecostModel:
      warmCache: true
      warmSavingsCache: true
      etl: true
      etlCloudAsset: true

    reporting:
      valuesReporting: true

    costAnalyzer:
      enabled: true

    notifications:
      alertConfigs:
        budget:
          enabled: true
          aggregation: namespace
          window: 7d
          threshold: 1000  # Alert if weekly spend exceeds $1000
        efficiency:
          enabled: true
          threshold: 0.2  # Alert if efficiency drops below 20%
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubecost
  namespace: estatewise
  labels:
    app: kubecost
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kubecost
  template:
    metadata:
      labels:
        app: kubecost
    spec:
      serviceAccountName: kubecost
      containers:
        - name: cost-analyzer
          image: gcr.io/kubecost1/cost-analyzer:latest
          ports:
            - containerPort: 9090
              name: http
          env:
            - name: PROMETHEUS_SERVER_ENDPOINT
              value: "http://prometheus:9090"
            - name: CLOUD_PROVIDER_API_KEY
              valueFrom:
                secretKeyRef:
                  name: kubecost-secrets
                  key: cloud-api-key
          volumeMounts:
            - name: kubecost-data
              mountPath: /var/configs
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 2Gi
      volumes:
        - name: kubecost-data
          persistentVolumeClaim:
            claimName: kubecost-pvc
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubecost
  namespace: estatewise
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kubecost
rules:
  - apiGroups: [""]
    resources:
      - nodes
      - pods
      - services
      - resourcequotas
      - replicationcontrollers
      - limitranges
      - persistentvolumeclaims
      - persistentvolumes
      - namespaces
      - endpoints
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources:
      - statefulsets
      - deployments
      - replicasets
      - daemonsets
    verbs: ["get", "list", "watch"]
  - apiGroups: ["batch"]
    resources:
      - cronjobs
      - jobs
    verbs: ["get", "list", "watch"]
  - apiGroups: ["storage.k8s.io"]
    resources:
      - storageclasses
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubecost
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubecost
subjects:
  - kind: ServiceAccount
    name: kubecost
    namespace: estatewise
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kubecost-pvc
  namespace: estatewise
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
  name: kubecost
  namespace: estatewise
spec:
  type: ClusterIP
  ports:
    - port: 9090
      targetPort: 9090
      name: http
  selector:
    app: kubecost
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cost-optimization-analyzer
  namespace: estatewise
spec:
  schedule: "0 8 * * 1"  # Weekly on Monday at 8 AM
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: analyzer
              image: bitnami/kubectl:latest
              command:
                - /bin/bash
                - -c
                - |
                  #!/bin/bash
                  set -e

                  echo "Analyzing infrastructure costs and optimization opportunities..."

                  # Get resource usage
                  echo "=== Resource Usage by Namespace ==="
                  kubectl top pods --all-namespaces --sort-by=cpu | head -20

                  # Find pods with low CPU usage
                  echo "=== Pods with Low CPU Utilization (<10%) ==="
                  kubectl top pods --all-namespaces | awk 'NR>1 && $3 ~ /m$/ { gsub(/m/, "", $3); if ($3 < 100) print $0 }'

                  # Find pods with low memory usage
                  echo "=== Pods with Low Memory Utilization (<20%) ==="
                  kubectl get pods --all-namespaces -o json | \
                    jq -r '.items[] | select(.status.containerStatuses != null) |
                    "\(.metadata.namespace)/\(.metadata.name)"'

                  # Check for unused PVCs
                  echo "=== Unused PersistentVolumeClaims ==="
                  kubectl get pvc --all-namespaces -o json | \
                    jq -r '.items[] | select(.status.phase == "Bound") |
                    select(.spec.volumeName != null) |
                    "\(.metadata.namespace)/\(.metadata.name)"'

                  # Identify pods without resource limits
                  echo "=== Pods Without Resource Limits ==="
                  kubectl get pods --all-namespaces -o json | \
                    jq -r '.items[] | select(.spec.containers[].resources.limits == null) |
                    "\(.metadata.namespace)/\(.metadata.name)"'

                  # Generate recommendations
                  RECOMMENDATIONS=$(cat <<EOF
                  {
                    "text": "Weekly Cost Optimization Report",
                    "blocks": [
                      {
                        "type": "header",
                        "text": {
                          "type": "plain_text",
                          "text": "Infrastructure Cost Optimization Recommendations"
                        }
                      },
                      {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": "*Optimization Opportunities Identified:*\n• Review pods with low CPU/memory utilization\n• Consider rightsizing or using autoscaling\n• Clean up unused PVCs\n• Add resource limits to all pods"
                        }
                      }
                    ]
                  }
                  EOF
                  )

                  # Send to Slack
                  curl -X POST "${SLACK_WEBHOOK_URL}" \
                    -H 'Content-Type: application/json' \
                    -d "${RECOMMENDATIONS}"

                  echo "Cost optimization analysis completed"
              env:
                - name: SLACK_WEBHOOK_URL
                  valueFrom:
                    secretKeyRef:
                      name: slack-credentials
                      key: webhook-url
                      optional: true
              resources:
                requests:
                  cpu: 50m
                  memory: 128Mi
                limits:
                  cpu: 200m
                  memory: 256Mi
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cost-optimized-pdb
  namespace: estatewise
spec:
  minAvailable: 1
  selector:
    matchLabels:
      tier: production
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cost-optimization-policies
  namespace: estatewise
data:
  policies.yaml: |
    # Resource Rightsizing Recommendations
    rightsizing:
      cpu:
        overprovisioned_threshold: 0.3  # Flag if usage < 30% of request
        underprovisioned_threshold: 0.9  # Flag if usage > 90% of request
      memory:
        overprovisioned_threshold: 0.3
        underprovisioned_threshold: 0.9

    # Autoscaling Recommendations
    autoscaling:
      enabled_for:
        - deployment
        - statefulset
      min_replicas: 2
      max_replicas: 10
      target_cpu_utilization: 70
      target_memory_utilization: 80

    # Spot Instance Policies
    spot_instances:
      enabled: true
      workloads:
        - batch-jobs
        - non-critical-services
      fallback_on_demand: true
      max_price_percentage: 70  # Max 70% of on-demand price

    # Storage Optimization
    storage:
      cleanup_unused_pvc: true
      unused_threshold_days: 30
      resize_recommendations: true

    # Cost Allocation Tags
    tags:
      required:
        - team
        - environment
        - cost-center
        - application
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa-cost-optimized
  namespace: estatewise
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 2
          periodSeconds: 30
      selectPolicy: Max
