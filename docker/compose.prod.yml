name: estatewise-prod

services:
  mongo:
    image: mongo:7
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: estatewise
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "mongodb://localhost:27017/admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - estatewise

  backend:
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    env_file:
      - ../.env
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGO_URI: ${MONGO_URI:-mongodb://mongo:27017/estatewise}
      NEO4J_ENABLE: ${NEO4J_ENABLE:-false}
    depends_on:
      mongo:
        condition: service_healthy
    expose:
      - "3001"
    restart: unless-stopped
    networks:
      - estatewise

  frontend:
    build:
      context: ..
      dockerfile: docker/frontend.Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://backend:3001}
    env_file:
      - ../.env
    environment:
      NODE_ENV: production
      PORT: 3000
    depends_on:
      backend:
        condition: service_healthy
    expose:
      - "3000"
    restart: unless-stopped
    networks:
      - estatewise

  nginx:
    build:
      context: ..
      dockerfile: docker/nginx/Dockerfile
    depends_on:
      - frontend
      - backend
    ports:
      - "${NGINX_PORT:-80}:80"
    restart: unless-stopped
    networks:
      - estatewise

  neo4j:
    image: neo4j:5.22
    profiles: ["graph"]
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/neo4jpassword}
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
      NEO4J_server_bolt_advertised__address: "neo4j:7687"
      NEO4J_server_http_advertised__address: "neo4j:7474"
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    networks:
      - estatewise

networks:
  estatewise:
    driver: bridge

volumes:
  mongo-data:
  neo4j-data:
  neo4j-logs:
